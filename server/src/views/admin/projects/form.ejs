<%- include('../../layouts/main', { 
  title: (editMode ? 'Edit' : 'Add New') + ' Project | Portfolio Admin', 
  currentPage: 'projects',
  scripts: [
    'https://cdn.ckeditor.com/ckeditor5/36.0.1/classic/ckeditor.js',
    'https://cdn.jsdelivr.net/npm/dropzone@5.9.3/dist/min/dropzone.min.js',
    '/js/project-form.js'
  ],
  styles: [
    'https://cdn.jsdelivr.net/npm/dropzone@5.9.3/dist/min/dropzone.min.css',
    'https://cdn.jsdelivr.net/npm/dropzone@5.9.3/dist/min/basic.min.css'
  ]
}) %>

<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
  <h1 class="h2"><%= editMode ? 'Edit Project' : 'Add New Project' %></h1>
  <div class="btn-toolbar mb-2 mb-md-0">
    <a href="/admin/projects" class="btn btn-sm btn-outline-secondary me-2">
      <i class="fas fa-arrow-left me-1"></i> Back to Projects
    </a>
    <button type="submit" form="projectForm" class="btn btn-sm btn-primary">
      <i class="fas fa-save me-1"></i> <%= editMode ? 'Update' : 'Publish' %> Project
    </button>
  </div>
</div>

<div class="row
  <div class="col-lg-8">
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0">Project Details</h5>
      </div>
      <div class="card-body">
        <form id="projectForm" action="<%= editMode ? `/api/v1/projects/${project._id}` : '/api/v1/projects' %>" 
              method="POST" enctype="multipart/form-data">
          <% if (editMode) { %>
            <input type="hidden" name="_method" value="PATCH">
          <% } %>
          
          <!-- Title -->
          <div class="mb-3">
            <label for="title" class="form-label">Project Title *</label>
            <input type="text" class="form-control" id="title" name="title" 
                   value="<%= editMode ? project.title : '' %>" required>
          </div>
          
          <!-- Slug -->
          <div class="mb-3">
            <label for="slug" class="form-label">URL Slug</label>
            <div class="input-group">
              <span class="input-group-text">yourportfolio.com/projects/</span>
              <input type="text" class="form-control" id="slug" name="slug" 
                     value="<%= editMode ? project.slug : '' %>" 
                     placeholder="my-awesome-project">
            </div>
            <div class="form-text">Leave blank to auto-generate from title</div>
          </div>
          
          <!-- Description -->
          <div class="mb-3">
            <label for="shortDescription" class="form-label">Short Description *</label>
            <textarea class="form-control" id="shortDescription" name="shortDescription" 
                      rows="3" maxlength="160" required><%= editMode ? project.shortDescription : '' %></textarea>
            <div class="form-text">A brief description (max 160 characters) for project cards and SEO</div>
          </div>
          
          <!-- Full Content -->
          <div class="mb-3">
            <label for="content" class="form-label">Project Content *</label>
            <div id="editor"><%= editMode ? project.content : '<p>Write your project details here...</p>' %></div>
            <textarea name="content" id="content" class="d-none" required></textarea>
          </div>
          
          <!-- Technologies -->
          <div class="mb-3">
            <label class="form-label">Technologies Used</label>
            <select class="form-select" id="technologies" multiple>
              <% const allTech = ['HTML5', 'CSS3', 'JavaScript', 'React', 'Node.js', 'Express', 'MongoDB', 'PostgreSQL', 'Python', 'Django', 'Vue.js', 'Angular', 'SASS', 'Bootstrap', 'Tailwind CSS', 'jQuery', 'PHP', 'Laravel', 'Ruby on Rails', 'Java', 'Spring Boot', 'C#', '.NET', 'MySQL', 'PostgreSQL', 'Firebase', 'AWS', 'Docker', 'Git', 'REST API', 'GraphQL', 'TypeScript', 'Redux', 'MobX', 'Vuex', 'Next.js', 'Nuxt.js', 'Gatsby', 'Svelte', 'Flutter', 'React Native', 'Ionic', 'Electron', 'Webpack', 'Babel', 'Jest', 'Mocha', 'Chai', 'Cypress', 'Selenium', 'Jira', 'Trello', 'Figma', 'Adobe XD', 'Sketch', 'Photoshop', 'Illustrator'];
                 const projectTech = editMode ? project.technologies || [] : [];
                 allTech.forEach(tech => { 
                   const selected = projectTech.includes(tech) ? 'selected' : ''; 
              %>
                <option value="<%= tech %>" <%= selected %>><%= tech %></option>
              <% }); %>
            </select>
            <input type="hidden" name="technologies" id="technologiesInput" 
                   value="<%= editMode ? project.technologies.join(',') : '' %>">
            <div class="form-text">Start typing to search or add new technologies</div>
          </div>
          
          <!-- Project URL -->
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="projectUrl" class="form-label">Project URL</label>
                <input type="url" class="form-control" id="projectUrl" name="projectUrl" 
                       value="<%= editMode ? project.projectUrl || '' : '' %>" 
                       placeholder="https://example.com">
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="githubUrl" class="form-label">GitHub Repository</label>
                <input type="url" class="form-control" id="githubUrl" name="githubUrl" 
                       value="<%= editMode ? project.githubUrl || '' : '' %>" 
                       placeholder="https://github.com/username/repo">
              </div>
            </div>
          </div>
          
          <!-- Client & Date -->
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="client" class="form-label">Client/Company</label>
                <input type="text" class="form-control" id="client" name="client" 
                       value="<%= editMode ? project.client || '' : '' %>" 
                       placeholder="Acme Inc.">
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="completionDate" class="form-label">Completion Date</label>
                <input type="date" class="form-control" id="completionDate" name="completionDate" 
                       value="<%= editMode && project.completionDate ? new Date(project.completionDate).toISOString().split('T')[0] : '' %>">
              </div>
            </div>
          </div>
          
          <!-- Status & Visibility -->
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="status" class="form-label">Status</label>
                <select class="form-select" id="status" name="status" required>
                  <option value="draft" <%= editMode && project.status === 'draft' ? 'selected' : '' %>>Draft</option>
                  <option value="published" <%= !editMode || project.status === 'published' ? 'selected' : '' %>>Published</option>
                  <option value="archived" <%= editMode && project.status === 'archived' ? 'selected' : '' %>>Archived</option>
                </select>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Options</label>
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="featured" name="featured" 
                         <%= editMode && project.featured ? 'checked' : '' %>>
                  <label class="form-check-label" for="featured">Featured Project</label>
                </div>
              </div>
            </div>
          </div>
          
          <!-- SEO -->
          <div class="card bg-light mb-3">
            <div class="card-header">
              <h6 class="mb-0">SEO Settings</h6>
            </div>
            <div class="card-body">
              <div class="mb-3">
                <label for="metaTitle" class="form-label">Meta Title</label>
                <input type="text" class="form-control" id="metaTitle" name="metaTitle" 
                       value="<%= editMode ? project.metaTitle || '' : '' %>" 
                       placeholder="Leave blank to use project title">
                <div class="form-text">Recommended: 50-60 characters</div>
              </div>
              <div class="mb-3">
                <label for="metaDescription" class="form-label">Meta Description</label>
                <textarea class="form-control" id="metaDescription" name="metaDescription" 
                          rows="2" maxlength="160"><%= editMode ? project.metaDescription || '' : '' %></textarea>
                <div class="form-text">Recommended: 150-160 characters</div>
              </div>
              <div class="mb-0">
                <label for="metaKeywords" class="form-label">Meta Keywords</label>
                <input type="text" class="form-control" id="metaKeywords" name="metaKeywords" 
                       value="<%= editMode ? project.metaKeywords || '' : '' %>" 
                       placeholder="comma, separated, keywords">
              </div>
            </div>
          </div>
          
          <div class="d-flex justify-content-between">
            <a href="<%= editMode ? `/admin/projects/${project._id}` : '/admin/projects' %>" 
               class="btn btn-outline-secondary">
              Cancel
            </a>
            <div>
              <% if (editMode) { %>
                <a href="#" class="btn btn-outline-danger me-2" id="deleteBtn">
                  <i class="fas fa-trash me-1"></i> Delete
                </a>
              <% } %>
              <button type="submit" class="btn btn-primary">
                <i class="fas fa-save me-1"></i> <%= editMode ? 'Update' : 'Publish' %> Project
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
  
  <div class="col-lg-4">
    <!-- Featured Image -->
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0">Featured Image</h5>
      </div>
      <div class="card-body text-center">
        <div id="featuredImageContainer" class="mb-3">
          <% if (editMode && project.featuredImage) { %>
            <img src="<%= project.featuredImage.url %>" 
                 alt="<%= project.title %>" 
                 class="img-fluid rounded mb-2" 
                 style="max-height: 200px;">
            <div class="d-flex justify-content-center gap-2">
              <button class="btn btn-sm btn-outline-danger" id="removeFeaturedImage">
                <i class="fas fa-trash me-1"></i> Remove
              </button>
            </div>
            <input type="hidden" name="featuredImage" value="<%= project.featuredImage._id %>">
          <% } else { %>
            <div class="border rounded p-5 text-center bg-light">
              <i class="fas fa-image fa-3x text-muted mb-3"></i>
              <p class="mb-0 text-muted">No featured image selected</p>
            </div>
          <% } %>
        </div>
        <div class="d-grid">
          <button class="btn btn-outline-primary" id="uploadFeaturedImage">
            <i class="fas fa-upload me-1"></i> Upload Image
          </button>
          <input type="file" id="featuredImageInput" accept="image/*" class="d-none">
        </div>
        <div class="form-text mt-2">Recommended size: 1200x630px (16:9 aspect ratio)</div>
      </div>
    </div>
    
    <!-- Project Gallery -->
    <div class="card mb-4">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Project Gallery</h5>
        <button class="btn btn-sm btn-outline-primary" id="openMediaLibrary">
          <i class="fas fa-images me-1"></i> Media Library
        </button>
      </div>
      <div class="card-body">
        <div id="galleryDropzone" class="dropzone">
          <div class="dz-message" data-dz-message>
            <i class="fas fa-cloud-upload-alt fa-2x text-muted mb-2"></i>
            <p class="mb-0">Drop files here or click to upload</p>
            <div class="small text-muted">(Images, videos, PDFs, etc.)</div>
          </div>
        </div>
        
        <div id="galleryPreview" class="mt-3">
          <% if (editMode && project.gallery && project.gallery.length > 0) { %>
            <div class="row g-2">
              <% project.gallery.forEach((image, index) => { %>
                <div class="col-6 col-md-4" data-id="<%= image._id %>">
                  <div class="position-relative">
                    <img src="<%= image.thumbnail || image.url %>" 
                         class="img-fluid rounded border" 
                         style="height: 80px; width: 100%; object-fit: cover;"
                         alt="Gallery image <%= index + 1 %>">
                    <button class="btn btn-sm btn-danger position-absolute top-0 end-0 m-1 p-1 rounded-circle remove-gallery-image" 
                            style="width: 20px; height: 20px; line-height: 1;"
                            data-id="<%= image._id %>">
                      <i class="fas fa-times"></i>
                    </button>
                    <input type="hidden" name="gallery[]" value="<%= image._id %>">
                  </div>
                </div>
              <% }) %>
            </div>
          <% } else { %>
            <p class="text-muted text-center py-3 mb-0">No gallery images added yet.</p>
          <% } %>
        </div>
      </div>
    </div>
    
    <!-- Publish Box -->
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">Publish</h5>
      </div>
      <div class="card-body">
        <div class="d-grid gap-2">
          <button type="submit" form="projectForm" class="btn btn-primary">
            <i class="fas fa-save me-1"></i> <%= editMode ? 'Update' : 'Publish' %> Project
          </button>
          <% if (editMode) { %>
            <div class="text-center small text-muted mt-2">
              Last updated: <%= new Date(project.updatedAt).toLocaleString() %>
              <% if (project.updatedAt.toString() !== project.createdAt.toString()) { %>
                <br>Created: <%= new Date(project.createdAt).toLocaleDateString() %>
              <% } %>
            </div>
          <% } %>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Delete Project</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete this project? This action cannot be undone.</p>
        <p class="text-danger">All project data, including images, will be permanently removed.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <form action="/api/v1/projects/<%= editMode ? project._id : '' %>" method="POST" id="deleteForm">
          <input type="hidden" name="_method" value="DELETE">
          <button type="submit" class="btn btn-danger">
            <i class="fas fa-trash me-1"></i> Delete Project
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Media Library Modal -->
<div class="modal fade" id="mediaLibraryModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Media Library</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <div class="btn-group" role="group">
            <button type="button" class="btn btn-outline-secondary active" data-media-type="all">All Items</button>
            <button type="button" class="btn btn-outline-secondary" data-media-type="image">Images</button>
            <button type="button" class="btn btn-outline-secondary" data-media-type="document">Documents</button>
          </div>
          <div>
            <button class="btn btn-primary" id="insertSelectedMedia" disabled>
              <i class="fas fa-plus me-1"></i> Insert Selected
            </button>
          </div>
        </div>
        
        <div class="border rounded p-3 mb-3">
          <div class="dropzone" id="mediaUploadDropzone">
            <div class="dz-message" data-dz-message>
              <i class="fas fa-cloud-upload-alt fa-2x text-muted mb-2"></i>
              <p class="mb-0">Drop files here or click to upload</p>
            </div>
          </div>
        </div>
        
        <div class="row g-3" id="mediaLibraryGrid">
          <!-- Media items will be loaded here via JavaScript -->
          <div class="col-12 text-center py-5">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2 mb-0">Loading media library...</p>
          </div>
        </div>
      </div>
      <div class="modal-footer justify-content-between">
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="selectAllMedia">
          <label class="form-check-label" for="selectAllMedia">
            Select all
          </label>
        </div>
        <div>
          <button type="button" class="btn btn-outline-secondary me-2" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="confirmMediaSelection">Insert Selected</button>
        </div>
      </div>
    </div>
  </div>
</div>
